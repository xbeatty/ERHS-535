---
title: "Food Security in South America"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
library(tidytuesdayR)
library(forcats)
library(readr)
library(stringr)
library(rnaturalearth)
library(rnaturalearthdata)
library(maps)
library(sf)


# Load data
food_security <- read_csv(
  "https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2025/2025-10-14/food_security.csv"
)

food_security$Item <- as.factor(food_security$Item)
food_security$Area <- as.factor(food_security$Area)

# South America subset
food_south <- food_security %>%
  filter(Area %in% c(
    "Argentina", "Bolivia (Plurinational State of)", "Brazil", "Chile", "Colombia",
    "Ecuador", "Guyana", "Paraguay", "Uruguay", "Peru", "Suriname",
    "Venezuela (Bolivarian Republic of)"
  ))

# KP indicators – food insecurity and undernourishment (all residents)
kp_indicators <- c(
  "Number of moderately or severely food insecure people (million) (3-year average)",
  "Number of moderately or severely food insecure people (million) (annual value)",
  "Number of severely food insecure people (million) (3-year average)",
  "Number of severely food insecure people (million) (annual value)",
  "Number of people undernourished (million) (3-year average)",
  "Number of people undernourished (million) (annual value)",
  "Prevalence of moderate or severe food insecurity in the total population (percent) (3-year average)",
  "Prevalence of moderate or severe food insecurity in the total population (percent) (annual value)",
  "Prevalence of severe food insecurity in the total population (percent) (3-year average)",
  "Prevalence of severe food insecurity in the total population (percent) (annual value)",
  "Prevalence of undernourishment (percent) (3-year average)",
  "Prevalence of undernourishment (percent) (annual value)"
)

```

Column {data-width=900}
-----------------------------------------------------------------------

```{r fig.width=7, fig.height=7}

food_south <- food_south %>%
  mutate(
    Area = str_replace(Area, " \\(Plurinational State of\\)", ""),
    Area = str_replace(Area, " \\(Bolivarian Republic of\\)", "")
  )

# Choose one KP indicator for all residents, so we can modify this one if we want for a different story
kp_indicator <- "Prevalence of moderate or severe food insecurity in the total population (percent) (3-year average)"

# Filter to that indicator in South America
kp_all <- food_south %>%
  filter(Item == kp_indicator)

# For each country, keep the most recent Year_End...Also can change this to a different yeari f we want
kp_latest <- kp_all %>%
  group_by(Area) %>%
  filter(Year_End == max(Year_End, na.rm = TRUE)) %>%
  ungroup()

# Clean Area names to match natural earth "sovereignt"
kp_latest <- kp_latest %>%
  mutate(
    Area_clean = as.character(Area),
    Area_clean = str_replace(Area_clean, " \\(Plurinational State of\\)", ""),
    Area_clean = str_replace(Area_clean, " \\(Bolivarian Republic of\\)", "")
  )

# World map and South America subset
world <- ne_countries(scale = "medium", returnclass = "sf")

map_sa <- world %>%
  filter(sovereignt %in% c(
    "Argentina", "Bolivia", "Brazil", "Chile", "Colombia", "Ecuador",
    "Guyana", "Paraguay", "Uruguay", "Peru", "Suriname", "Venezuela"
  ))

# Join KP data to map by country name
map_joined_kp <- map_sa %>%
  left_join(kp_latest, by = c("sovereignt" = "Area_clean"))

# Build interactive map
p_kp_map <- ggplot(
  map_joined_kp,
  aes(
    text = paste0(
      "Country: ", sovereignt,
      "<br>Year_End: ", Year_End,
      "<br>Value: ", round(Value, 1), " ", Unit
    )
  )
) +
  geom_sf(aes(fill = Value), color = "white") +
  scale_fill_viridis_c(option = "C", na.value = "grey80") +
  labs(
    title = "Moderate-Severe Food Insecurity in South America: 3-Yr Avg.",
    fill  = "Percent"
  ) +
  theme_minimal()

ggplotly(p_kp_map, tooltip = "text")
```

```{r fig.width=7, fig.height=3}
### South America – Food insecurity and undernourishment

# Choose a single indicator and year for this pane, again can change this as we see fit.
kp_indicator <- "Prevalence of moderate or severe food insecurity in the total population (percent) (3-year average)"

latest_year <- max(food_south$Year_End[food_south$Item == kp_indicator], na.rm = TRUE)

kp_data_year <- food_south %>%
  filter(
    Item == kp_indicator,
    Year_End == latest_year
  )

kp_data_year <- kp_data_year %>%
  filter(!is.na(Value)) %>%            # remove NAs that break fct_reorder
  mutate(Area = factor(Area))          # drop unused/empty factor levels


# Bar plot across South American countries for latest_year
p_kp <- ggplot(
  kp_data_year,
  aes(
    y = fct_reorder(Area, Value),
    x = Value,
    text = paste0(
      "Area: ", Area,
      "<br>Value: ", round(Value, 2), " ", Unit,
      "<br>Year_End: ", Year_End
    )
  )
) +
  geom_col(fill = "darkblue") +
  labs(
    x = "Percent",
    y = NULL,
    title = "Moderate-Severe Food Insecurity in South America: 3-Yr Avg."
  ) +
  theme_minimal()

ggplotly(p_kp, tooltip = "text")

```
Horizontal bar chart showing the 3-year average prevalence of moderate to severe food insecurity (%) across selected South American countries, with Peru, Argentina, and Ecuador having the highest rates and some countries omitted due to missing data.

```{r fig.width=7, fig.height=7}
library(ggplot2)
library(plotly)
library(dplyr)

kp_indicator <- "Prevalence of moderate or severe food insecurity in the total population (percent) (3-year average)"

kp_ts_all <- food_south %>%
  filter(Item == kp_indicator) %>%
  arrange(Area, Year_End)

p_ts_facets <- ggplot(
  kp_ts_all,
  aes(
    x = Year_End,
    y = Value,
    group = Area,
    text = paste0(
      "Area: ", Area,
      "<br>Year: ", Year_End,
      "<br>Value: ", round(Value, 2), " ", Unit
    )
  )
) +
  geom_line(color = "darkblue") +
  geom_point(color = "darkblue") +
  facet_wrap(~ Area) +
  labs(
    x = "Year",        # Changed axis label
    y = "Percent",
    title = "Trend in food insecurity by country"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.x = element_text(margin = margin(t = 10))  # Move x label down
  )

ggplotly(p_ts_facets, tooltip = "text")


```
These plots shows trends in moderate or severe food insecurity across South American countries from 2016–2024. Most countries experienced rising food insecurity over time, with particularly sharp increases in Argentina, Ecuador, Paraguay, and Peru. A few countries, such as Brazil and Uruguay, show relatively lower and more stable levels, while Venezuela remains consistently high.



Column {.tabset}
-----------------------------------------------------------------------

### Adult Population Info

```{r, Adult,  message=FALSE, warning=FALSE, include=FALSE}

# Filter only male & female prevalence
adult_food <- food_south %>% 
  filter(Item %in% c(
    "Prevalence of moderate or severe food insecurity in the male adult population (percent) (3-year average)",
    "Prevalence of moderate or severe food insecurity in the female adult population (percent) (3-year average)",
    "Share of dietary energy supply derived from cereals, roots and tubers (percent) (3-year average)"
  )) %>% 
  select(Area, Item, Value)

# Average repeated values
adult_food_clean <- adult_food %>% 
  group_by(Area, Item) %>% 
  summarise(Value = mean(Value), .groups = "drop")

#create food map
food_map <- adult_food_clean %>% 
  filter(str_detect(Item, "food insecurity")) %>% 
  mutate(sex = case_when(
    str_detect(Item, "female") ~ "Female",
    str_detect(Item, "male") ~ "Male",
    TRUE ~ NA_character_
  ))

# Load world map

world <- ne_countries(scale = "medium", returnclass = "sf")
names(world)


#Filter only for countires in SA
map_sa <- world %>%
  filter(sovereignt %in% c("Argentina", "Bolivia", "Brazil", "Chile","Colombia", "Ecuador",
                   "Guyana", "Paraguay", "Uruguay", "Peru", "Suriname", "Venezuela")  
         )

# Join your data to the map
map_joined <- map_sa %>% 
  left_join(food_map, by = c("sovereignt" = "Area"))

```

```{r message=FALSE, warning=FALSE}
ggplot(map_joined %>% filter(sex == "Female")) +
  geom_sf(aes(fill = Value), color = "white") +
  scale_fill_viridis_c(option = "C", na.value = "grey80") +
  labs(
    title = "Female Food Insecurity (Moderate or Severe)",
    fill  = "Percent"
  ) +
  theme_minimal()

ggplot(map_joined %>% filter(sex == "Male")) +
  geom_sf(aes(fill = Value), color = "white") +
  scale_fill_viridis_c(option = "D", na.value = "grey80") +
  labs(
    title = "Male Food Insecurity (Moderate or Severe)",
    fill  = "Percent"
  ) +
  theme_minimal()

```

### Children Population Info

```{r children info, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(ggthemes)

food_security <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2025/2025-10-14/food_security.csv')

food_security$Item <- as.factor(food_security$Item)
food_security$Area <- as.factor(food_security$Area)

food_south <- food_security %>%
  filter(Area == c("Argentina", "Bolivia", "Brazil", "Chile","Colombia", "Ecuador",
                   "Guyana", "Paraguay", "Uruguay", "Peru", "Suriname", "Venezuela (Bolivarian Republic of)")  
         )

children_food <- food_south %>% 
  filter(Item %in% c(
    "Number of children under 5 years of age who are overweight (modeled estimates) (million)", 
    "Number of children under 5 years of age who are stunted (modeled estimates) (million)")) %>% 
  select(Year_Start, Year_End, Area, Item, Value)

children_food_clean <- children_food %>%
  mutate(
    Area = as.character(Area),  # ensure it's character
    Area = str_replace(Area, " \\(Bolivarian Republic of\\)", "")  # remove parentheses
  )

ggplot(children_food_clean, aes(y = fct_reorder(Area, Value), x = Value, fill = Item)) +
  geom_col(position = "dodge") +
  scale_fill_manual(
    name = "Observation",
    values = c(
      "Number of children under 5 years of age who are overweight (modeled estimates) (million)" = "blue",
      "Number of children under 5 years of age who are stunted (modeled estimates) (million)" = "limegreen"
    ),
    labels = c(
      "Number of children under 5 years of age who are overweight (modeled estimates) (million)" = "Overweight",
      "Number of children under 5 years of age who are stunted (modeled estimates) (million)" = "Stunted"
    )
  ) +
  labs(
    y = NULL,
    x = "Number of Children (millions)",
    title = "Nutrition in South American Children Under 5"
  ) +
  theme_minimal() +
  theme(
    legend.direction = "vertical",
    legend.position = "right"
  )
```
Here we are comparing the number of overweight vs stunted children across South America in 2024.Both Colombia and Argentina have similar population sizes, 53 million and 45 million respectively, yet, Argentina has a **significantly smaller** stunted child population compared to Colombia. Peru, which is **7.8% of the total South American population**, has the second highest group of stunted children. Since 2022, Brazil has seen a **decrease in food insecurity** across the total population. This is reflected in the number of children that are overweight in the Brazil population, which could be a product of that trend.

